name: Test Kubernetes / Helm Install

on:
  pull_request:
    branches:
      - main
      - develop

jobs:
  install-helm-charts:
    runs-on: ubuntu-latest
    services:
      # Runs a local Docker registry accessible at localhost:5000
      registry:
        image: registry:2
        ports:
          - 5000:5000
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Start minikube
        uses: medyagh/setup-minikube@latest

      - name: Install Helm
        run: |
          curl https://raw.githubusercontent.com/helm/helm/main/scripts/get-helm-3 | bash

      - name: Create Namespace
        run: kubectl create namespace tradestream-namespace

      - name: Create Secrets
        run: |
          kubectl create secret generic \
            coinmarketcap \
            --from-literal=apiKey=FAKE_API_KEY \
            --namespace=tradestream-namespace

      - uses: bazel-contrib/setup-bazel@0.9.1
        with:
          # Avoid downloading Bazel every time
          bazelisk-cache: true
          # Store build cache per workflow
          disk-cache: ${{ github.workflow }}
          # Share repository cache between workflows
          repository-cache: true

      - name: Build and Push the Data Ingestion Image
        run: |
          # Push to local registry
          bazel run //src/main/java/com/verlumen/tradestream/ingestion:push_image \
            --verbose_failures \
            --sandbox_debug \
            -- \
            --repository localhost:5000/tradestream-data-ingestion \
            --tag "latest"

      - name: Build and Push the Strategy Engine Image
        run: |
          # Push to local registry
          bazel run //src/main/java/com/verlumen/tradestream/strategies:push_image \
            --verbose_failures \
            --sandbox_debug \
            -- \
            --repository localhost:5000/tradestream-strategy-engine \
            --tag "latest"

      - name: Pull Images into Local Docker Daemon
        run: |
          # Pull the images from the local registry into the local Docker daemon
          docker pull localhost:5000/tradestream-data-ingestion:latest
          docker pull localhost:5000/tradestream-strategy-engine:latest

          # Retag the images to remove the registry prefix, so Kubernetes doesn't try to pull them remotely
          docker tag localhost:5000/tradestream-data-ingestion:latest tradestream-data-ingestion:latest
          docker tag localhost:5000/tradestream-strategy-engine:latest tradestream-strategy-engine:latest

      - name: Load Images into Minikube
        run: |
          # Load the retagged images into Minikube's image cache
          minikube image load tradestream-data-ingestion:latest
          minikube image load tradestream-strategy-engine:latest

      - name: Install TradeStream Helm Chart
        run: |
          helm dependency update charts/tradestream && \
          helm install my-tradestream charts/tradestream \
            --namespace tradestream-namespace \
            --set strategyEngine.image.repository=tradestream-strategy-engine \
            --set strategyEngine.image.tag=latest \
            --set 'strategyEngine.args[0]=--runMode=dry' \
            --set dataIngestion.image.repository=tradestream-data-ingestion \
            --set dataIngestion.image.tag=latest \
            --set 'dataIngestion.args[0]=--runMode=dry'

      - name: Wait for Pods to be Ready
        run: |
          kubectl wait --for=condition=Ready \
            pod -l app=my-tradestream \
            -n tradestream-namespace \
            --timeout=3m || (
              kubectl get pods -n tradestream-namespace &&
              kubectl describe pod -l app=my-tradestream -n tradestream-namespace &&
              false
            )

      - name: Verify Installations
        run: |
          kubectl get pods -n tradestream-namespace
