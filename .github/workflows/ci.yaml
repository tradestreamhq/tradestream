name: CI Workflow

on:
  pull_request:
    branches:
      - main
      - develop

jobs:
  install-helm-charts:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v3
  
      - name: Start minikube
        uses: medyagh/setup-minikube@latest

      - name: Install Helm
        run: |
          curl https://raw.githubusercontent.com/helm/helm/main/scripts/get-helm-3 | bash

      - name: Add Helm Repositories
        run: |
          helm repo add bitnami https://charts.bitnami.com/bitnami
          helm repo update

      - name: Install Sealed Secrets Controller
        run: |
          # Create a dedicated namespace for the Sealed Secrets controller
          kubectl create namespace sealed-secrets
          # Install the Sealed Secrets controller into its namespace
          helm install my-sealed-secrets-controller bitnami/sealed-secrets --namespace sealed-secrets

      - name: Wait for Sealed Secrets Controller to be Ready
        run: |
          echo "Waiting for Sealed Secrets Controller to be ready..."
          # Use labels to find the correct deployment
          kubectl rollout status deployment -n sealed-secrets -l app.kubernetes.io/name=sealed-secrets,app.kubernetes.io/instance=my-sealed-secrets-controller --timeout=120s

      - name: Install TradeStream Helm Chart
        run: |
          # Ensure that the SealedSecret is in the same namespace as the application
          helm dependency update charts/tradestream
          helm install my-tradestream charts/tradestream --namespace tradestream-namespace --create-namespace

      - name: Wait for All Pods to be Ready
        run: |
          echo "Waiting for all pods to be ready in namespace 'tradestream-namespace'..."
          timeout=90  # Total time to wait in seconds
          interval=10  # Interval between checks in seconds
          end_time=$((SECONDS+timeout))

          while [ $SECONDS -lt $end_time ]; do
            not_ready_pods=$(kubectl get pods -n tradestream-namespace --no-headers | grep -vE 'Running|Completed' | wc -l)
            if [ "$not_ready_pods" -eq "0" ]; then
              echo "All pods are ready."
              break
            else
              echo "Some pods are not ready yet. Current status:"
              kubectl get pods -n tradestream-namespace
              echo "Waiting for $interval seconds before rechecking..."
              sleep $interval
            fi
          done

          if [ $SECONDS -ge $end_time ]; then
            echo "Timeout reached while waiting for pods to be ready."
            kubectl get pods -n tradestream-namespace

            echo -e "\nGathering detailed status and logs for non-ready pods..."
            not_ready_pod_names=$(kubectl get pods -n tradestream-namespace --no-headers | grep -vE 'Running|Completed' | awk '{print $1}')
            for pod in $not_ready_pod_names; do
              echo -e "\nDetails for pod $pod:"
              kubectl describe pod $pod -n tradestream-namespace

              containers=$(kubectl get pod $pod -n tradestream-namespace -o jsonpath='{.spec.containers[*].name}')
              for container in $containers; do
                echo -e "\nLogs for container '$container' in pod '$pod':"
                kubectl logs $pod -n tradestream-namespace -c $container
              done
            done
            exit 1
          fi

      - name: Verify Installations
        run: |
          kubectl get pods -n tradestream-namespace

      - name: Verify Sealed Secret
        run: |
          kubectl get secret coinmarketcap-api-key -n tradestream-namespace

      - name: Cleanup Resources
        if: always()
        run: |
          helm uninstall my-tradestream --namespace tradestream-namespace
          helm uninstall my-sealed-secrets-controller --namespace sealed-secrets
          kubectl delete namespace tradestream-namespace sealed-secrets
