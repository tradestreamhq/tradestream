name: "google-java-format"
on:
  pull_request:
    paths: ["**/*.java"]
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true
permissions:
  contents: read
  pull-requests: write
jobs:
  format:
    name: runner / google-java-format
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - name: Set up Java
        uses: actions/setup-java@v4
        with:
          distribution: "temurin"
          java-version: "17"
      - name: Download google-java-format
        run: |
          wget -q https://github.com/google/google-java-format/releases/download/v1.24.0/google-java-format-1.24.0-all-deps.jar \
            -O /tmp/google-java-format.jar
      - name: Get changed Java files
        id: changed-files
        run: |
          # Get list of changed Java files in this PR
          CHANGED_FILES=$(git diff --name-only --diff-filter=ACMRT origin/main...HEAD | grep '\.java$' || true)
          if [ -z "$CHANGED_FILES" ]; then
            echo "has_java_files=false" >> $GITHUB_OUTPUT
          else
            echo "has_java_files=true" >> $GITHUB_OUTPUT
            # Save files to a temp file for later use
            echo "$CHANGED_FILES" > /tmp/changed_java_files.txt
            echo "Found changed Java files:"
            cat /tmp/changed_java_files.txt
          fi
      - name: Format changed Java files
        if: steps.changed-files.outputs.has_java_files == 'true'
        run: |
          # Format each changed file
          while IFS= read -r file; do
            if [ -f "$file" ]; then
              echo "Formatting: $file"
              java --add-exports jdk.compiler/com.sun.tools.javac.api=ALL-UNNAMED \
                   --add-exports jdk.compiler/com.sun.tools.javac.file=ALL-UNNAMED \
                   --add-exports jdk.compiler/com.sun.tools.javac.parser=ALL-UNNAMED \
                   --add-exports jdk.compiler/com.sun.tools.javac.tree=ALL-UNNAMED \
                   --add-exports jdk.compiler/com.sun.tools.javac.util=ALL-UNNAMED \
                   -jar /tmp/google-java-format.jar --replace "$file"
            fi
          done < /tmp/changed_java_files.txt
      - name: Check for changes
        if: steps.changed-files.outputs.has_java_files == 'true'
        id: verify-changed-files
        run: |
          if [ -n "$(git status --porcelain)" ]; then
            echo "changed=true" >> $GITHUB_OUTPUT
          else
            echo "changed=false" >> $GITHUB_OUTPUT
          fi
      - name: Annotate diff changes using reviewdog
        if: steps.changed-files.outputs.has_java_files == 'true' && steps.verify-changed-files.outputs.changed == 'true'
        uses: reviewdog/action-suggester@v1
        with:
          tool_name: google-java-format
      - name: Fail if formatting issues found
        if: steps.changed-files.outputs.has_java_files == 'true' && steps.verify-changed-files.outputs.changed == 'true'
        run: |
          echo "::error::Java formatting issues detected. Please apply the suggested changes."
          git diff --stat
          exit 1
