name: CI Workflow

on:
  pull_request:
    branches:
      - main
      - develop

jobs:
  run-unit-tests:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4

    - name: Set up Bazelisk
      uses: philwo/bazelisk-action@v1

    - name: Compute Cache Key
      id: compute-cache-key
      run: |
        BAZEL_VERSION=$(bazel version | grep 'Build label' | awk '{print $3}')
        WORKSPACE_HASH=$(sha256sum WORKSPACE | awk '{print $1}')
        echo "CACHE_KEY=bazel-cache-${BAZEL_VERSION}-${WORKSPACE_HASH}" >> $GITHUB_ENV

    - name: Cache Bazel Directories
      uses: actions/cache@v4
      with:
        path: |
          ~/.cache/bazel
          .bazel-disk-cache
          external_dependency_dir # Replace with actual dependency directories if any
        key: ${{ env.CACHE_KEY }}
        restore-keys: |
          bazel-cache-${{ env.BAZEL_VERSION }}-
          bazel-cache-

    - name: Run Bazel Tests
      run: |
        mkdir -p .bazel-disk-cache
        bazel test //... --test_output=all --disk_cache=$(pwd)/.bazel-disk-cache

    - name: Post Build Cache Info
      if: always()
      run: |
        echo "Used Cache Key: ${{ env.CACHE_KEY }}"
