{{- if .Values.databaseMigration.enabled }}
apiVersion: v1
kind: ConfigMap
metadata:
  name: {{ include "tradestream.fullname" . }}-db-migrations
  namespace: {{ .Release.Namespace }}
  labels:
    app: {{ include "tradestream.name" . }}
    component: database-migration
    release: {{ .Release.Name }}
data:
  V1__baseline_strategies_table.sql: |
    -- V1__baseline_strategies_table.sql
    -- Baseline migration capturing existing Strategies table schema

    CREATE TABLE IF NOT EXISTS Strategies (
        strategy_id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
        symbol VARCHAR NOT NULL,
        strategy_type VARCHAR NOT NULL,
        parameters JSONB NOT NULL,
        first_discovered_at TIMESTAMP NOT NULL DEFAULT NOW(),
        last_evaluated_at TIMESTAMP NOT NULL DEFAULT NOW(),
        current_score DOUBLE PRECISION NOT NULL,
        is_active BOOLEAN NOT NULL DEFAULT TRUE,
        strategy_hash VARCHAR UNIQUE NOT NULL,
        discovery_symbol VARCHAR,
        discovery_start_time TIMESTAMP,
        discovery_end_time TIMESTAMP,
        created_at TIMESTAMP NOT NULL DEFAULT NOW(),
        updated_at TIMESTAMP NOT NULL DEFAULT NOW()
    );

    CREATE INDEX IF NOT EXISTS idx_strategies_symbol ON Strategies(symbol);
    CREATE INDEX IF NOT EXISTS idx_strategies_strategy_type ON Strategies(strategy_type);
    CREATE INDEX IF NOT EXISTS idx_strategies_current_score ON Strategies(current_score);
    CREATE INDEX IF NOT EXISTS idx_strategies_is_active ON Strategies(is_active);
    CREATE INDEX IF NOT EXISTS idx_strategies_discovery_symbol ON Strategies(discovery_symbol);
    CREATE INDEX IF NOT EXISTS idx_strategies_created_at ON Strategies(created_at);

  V2__add_strategy_specs.sql: |
    -- V2__add_strategy_specs.sql
    -- Add strategy specification tables for config-based strategy definitions

    CREATE TABLE IF NOT EXISTS strategy_specs (
        id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
        name VARCHAR(255) UNIQUE NOT NULL,
        version INTEGER DEFAULT 1,
        description TEXT,
        complexity VARCHAR(50),
        indicators JSONB NOT NULL,
        entry_conditions JSONB NOT NULL,
        exit_conditions JSONB NOT NULL,
        parameters JSONB NOT NULL,
        source VARCHAR(50) NOT NULL,
        source_citation TEXT,
        parent_spec_id UUID REFERENCES strategy_specs(id),
        tags TEXT[],
        is_active BOOLEAN NOT NULL DEFAULT TRUE,
        created_at TIMESTAMP NOT NULL DEFAULT NOW(),
        updated_at TIMESTAMP NOT NULL DEFAULT NOW()
    );

    CREATE INDEX IF NOT EXISTS idx_strategy_specs_name ON strategy_specs(name);
    CREATE INDEX IF NOT EXISTS idx_strategy_specs_source ON strategy_specs(source);
    CREATE INDEX IF NOT EXISTS idx_strategy_specs_is_active ON strategy_specs(is_active);
    CREATE INDEX IF NOT EXISTS idx_strategy_specs_created_at ON strategy_specs(created_at);
    CREATE INDEX IF NOT EXISTS idx_strategy_specs_tags ON strategy_specs USING GIN(tags);

    CREATE TABLE IF NOT EXISTS strategy_implementations (
        id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
        spec_id UUID NOT NULL REFERENCES strategy_specs(id) ON DELETE CASCADE,
        parameters JSONB NOT NULL,
        discovered_by VARCHAR(50) NOT NULL,
        generation INTEGER,
        backtest_metrics JSONB,
        paper_metrics JSONB,
        live_metrics JSONB,
        status VARCHAR(20) NOT NULL DEFAULT 'CANDIDATE',
        deployed_at TIMESTAMP,
        retired_at TIMESTAMP,
        notes TEXT,
        created_at TIMESTAMP NOT NULL DEFAULT NOW(),
        updated_at TIMESTAMP NOT NULL DEFAULT NOW()
    );

    CREATE INDEX IF NOT EXISTS idx_strategy_impl_spec_id ON strategy_implementations(spec_id);
    CREATE INDEX IF NOT EXISTS idx_strategy_impl_discovered_by ON strategy_implementations(discovered_by);
    CREATE INDEX IF NOT EXISTS idx_strategy_impl_status ON strategy_implementations(status);
    CREATE INDEX IF NOT EXISTS idx_strategy_impl_created_at ON strategy_implementations(created_at);

    CREATE OR REPLACE FUNCTION update_updated_at_column()
    RETURNS TRIGGER AS $$
    BEGIN
        NEW.updated_at = NOW();
        RETURN NEW;
    END;
    $$ LANGUAGE plpgsql;

    DROP TRIGGER IF EXISTS update_strategy_specs_updated_at ON strategy_specs;
    CREATE TRIGGER update_strategy_specs_updated_at
        BEFORE UPDATE ON strategy_specs
        FOR EACH ROW
        EXECUTE FUNCTION update_updated_at_column();

    DROP TRIGGER IF EXISTS update_strategy_implementations_updated_at ON strategy_implementations;
    CREATE TRIGGER update_strategy_implementations_updated_at
        BEFORE UPDATE ON strategy_implementations
        FOR EACH ROW
        EXECUTE FUNCTION update_updated_at_column();

  V3__add_strategy_performance.sql: |
    -- V3__add_strategy_performance.sql
    -- Add strategy performance tracking tables

    CREATE TABLE IF NOT EXISTS strategy_performance (
        id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
        implementation_id UUID NOT NULL REFERENCES strategy_implementations(id) ON DELETE CASCADE,
        period_start TIMESTAMP NOT NULL,
        period_end TIMESTAMP NOT NULL,
        sharpe_ratio DECIMAL(10,4),
        sortino_ratio DECIMAL(10,4),
        calmar_ratio DECIMAL(10,4),
        win_rate DECIMAL(5,4),
        profit_factor DECIMAL(10,4),
        max_drawdown DECIMAL(10,4),
        avg_drawdown DECIMAL(10,4),
        volatility DECIMAL(10,4),
        var_95 DECIMAL(10,4),
        total_trades INTEGER NOT NULL DEFAULT 0,
        winning_trades INTEGER NOT NULL DEFAULT 0,
        losing_trades INTEGER NOT NULL DEFAULT 0,
        avg_trade_duration_seconds BIGINT,
        avg_profit_per_trade DECIMAL(20,8),
        total_return DECIMAL(10,4),
        annualized_return DECIMAL(10,4),
        environment VARCHAR(20) NOT NULL,
        instrument VARCHAR(50) NOT NULL,
        timeframe VARCHAR(20),
        raw_metrics JSONB,
        created_at TIMESTAMP NOT NULL DEFAULT NOW()
    );

    CREATE INDEX IF NOT EXISTS idx_perf_impl_id ON strategy_performance(implementation_id);
    CREATE INDEX IF NOT EXISTS idx_perf_impl_date ON strategy_performance(implementation_id, period_start);
    CREATE INDEX IF NOT EXISTS idx_perf_environment ON strategy_performance(environment);
    CREATE INDEX IF NOT EXISTS idx_perf_instrument ON strategy_performance(instrument);
    CREATE INDEX IF NOT EXISTS idx_perf_created_at ON strategy_performance(created_at);

  V4__add_signals.sql: |
    -- V4__add_signals.sql
    -- Add signals table for trading signal history

    CREATE TABLE IF NOT EXISTS signals (
        id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
        spec_id UUID REFERENCES strategy_specs(id) ON DELETE SET NULL,
        implementation_id UUID REFERENCES strategy_implementations(id) ON DELETE SET NULL,
        instrument VARCHAR(50) NOT NULL,
        signal_type VARCHAR(20) NOT NULL,
        strength DECIMAL(5,4),
        price DECIMAL(20,8) NOT NULL,
        bid_price DECIMAL(20,8),
        ask_price DECIMAL(20,8),
        volume DECIMAL(20,8),
        stop_loss DECIMAL(20,8),
        take_profit DECIMAL(20,8),
        position_size DECIMAL(10,4),
        outcome VARCHAR(20),
        exit_price DECIMAL(20,8),
        exit_time TIMESTAMP,
        pnl DECIMAL(20,8),
        pnl_percent DECIMAL(10,4),
        notified_at TIMESTAMP,
        notification_channels TEXT[],
        timeframe VARCHAR(20),
        metadata JSONB,
        created_at TIMESTAMP NOT NULL DEFAULT NOW()
    );

    CREATE INDEX IF NOT EXISTS idx_signals_instrument ON signals(instrument);
    CREATE INDEX IF NOT EXISTS idx_signals_instrument_time ON signals(instrument, created_at DESC);
    CREATE INDEX IF NOT EXISTS idx_signals_type ON signals(signal_type);
    CREATE INDEX IF NOT EXISTS idx_signals_spec_id ON signals(spec_id);
    CREATE INDEX IF NOT EXISTS idx_signals_impl_id ON signals(implementation_id);
    CREATE INDEX IF NOT EXISTS idx_signals_outcome ON signals(outcome);
    CREATE INDEX IF NOT EXISTS idx_signals_created_at ON signals(created_at DESC);
    CREATE INDEX IF NOT EXISTS idx_signals_instrument_type_time ON signals(instrument, signal_type, created_at DESC);
{{- end }}
